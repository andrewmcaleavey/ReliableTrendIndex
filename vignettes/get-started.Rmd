---
title: "Get started with the Reliable Trend Index (RTI)"
author: "Andrew A. McAleavey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started with the Reliable Trend Index (RTI)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 4.5,
  dpi = 120
)
set.seed(2025)
```

## What is RTI?

The **Reliable Trend Index (RTI)** is a reliability-based test of *within-person* linear change.  
Given a person’s observed series \(y_1, \dots, y_n\) at times \(t_1, \dots, t_n\), and **external** single-occasion standard deviation `sd` (same units as \(y\)) and reliability `r`, RTI tests whether the person’s slope \(\beta_1\) differs from 0.

Under the working model
\[
y_t = \beta_0 + \beta_1\,t + \varepsilon_t,\quad \varepsilon_t \sim (0,\sigma^2),\quad \sigma^2 = \texttt{sd}^2\,(1-r),
\]
the standard error of the OLS slope is
\[
\mathrm{SE}(\hat\beta_1) = \sqrt{\frac{\sigma^2}{S_{xx}}},\quad
S_{xx}=\sum (t-\bar t)^2.
\]
For equally spaced times \(t=1,\ldots,n\), \(S_{xx} = n(n^2-1)/12\).  
The RTI test statistic is \(Z=\hat\beta_1/\mathrm{SE}(\hat\beta_1)\) with a two-sided p-value from the standard normal.

When \(n=2\), RTI reduces to the classical **Reliable Change Index (RCI)** logic, replacing “difference” with the slope between the two occasions.

---

## Installation

The package isn’t on CRAN yet, install from GitHub:

```{r install, eval=FALSE}
# install.packages("remotes")
remotes::install_github("andrewmcaleavey/ReliableTrendIndex")
```

Load the package:

```{r}
library(ReliableTrendIndex)  
```

---

## Quick start: single case

Let’s create a short, improving series and supply external `sd` and `r`.

```{r}
# Simulated person: modest upward trend with noise
n  <- 8
t  <- 1:n
tc <- t - mean(t)                       # centered time (optional for interpretation)
y  <- 10 + 0.6 * tc + rnorm(n, 0, 2.5)  # intercept near mean(y)

sd_ext <- 8      # external single-occasion SD
r_ext  <- 0.85   # external reliability

fit <- rti(y, sd = sd_ext, r = r_ext, t = t, level = .95)
fit
```

Key pieces:

```{r}
fit$estimate    # slope beta1 (per 1 unit of t_c)
fit$se          # SE(beta1) from reliability model
fit$z; fit$p    # test and p-value
fit$ci          # 95% CI for beta1
```

Plot with different **uncertainty bands**:

```{r}
# Slope-only band (intercept treated as fixed)
plot(fit, band = "slope", show_points = TRUE, show_line = TRUE)

# Mean band: CI for fitted mean; includes intercept uncertainty (1/n term)
plot(fit, band = "mean", include_intercept_uncertainty = TRUE)

# Prediction band: for new observations (widest)
plot(fit, band = "prediction")
```

**Interpretation tip.**  
Use the *slope* band when communicating “direction and rate” of change (pivoting around mean time). Use the *mean* band when you want uncertainty of the fitted trajectory. Use the *prediction* band to set expectations for future noisy observations.

---

## Relation to RCI (n = 2)

```{r}
y2 <- c(12, 16)
t2 <- c(1, 2)
fit2 <- rti(y2, sd = sd_ext, r = r_ext, t = t2)
c(slope = fit2$estimate, se = fit2$se, z = fit2$z, p = fit2$p)
```

With two points, the slope is simply the difference per unit time; the SE collapses to the RCI denominator scaled by the spacing.

---

## Irregular spacing

You can pass arbitrary time points; RTI uses \(S_{xx}=\sum (t-\bar t)^2\) directly.

```{r}
tirr <- c(0, 1, 2, 4, 7, 10, 10.5, 13)  # uneven
yirr <- 9 + 0.4 * (tirr - mean(tirr)) + rnorm(length(tirr), 0, 2.5)

fit_irr <- rti(yirr, sd = sd_ext, r = r_ext, t = tirr)
fit_irr$estimate
plot(fit_irr, band = "mean")
```

---

## Grouped (panel) data with `rti_by()`

Use `rti_by()` to compute RTI per id from a long data frame. You can pass `sd` and `r` as **scalars** (applied to every id) or as **columns** containing per-id constants.

```{r}
# Example panel with three ids: up, down, flat trends
df <- data.frame(
  id   = rep(letters[1:3], each = 6),
  time = rep(1:6, times = 3),
  y    = c(
    5 + 0.8*(1:6) + rnorm(6, 0, 3),   # a: improving
    10 - 0.5*(1:6) + rnorm(6, 0, 3),  # b: worsening
    2 + 0.0*(1:6) + rnorm(6, 0, 3)    # c: flat
  )
)

# Single sd/r used for all ids
by_all <- rti_by(df, id, time, y, sd = sd_ext, r = r_ext)
by_all
```

Per-id `sd` and `r` as columns (must be constant within each id):

```{r}
sd_by_id <- setNames(c(7.0, 8.0, 6.5), letters[1:3])
r_by_id  <- setNames(c(0.88, 0.82, 0.90), letters[1:3])
df$sd <- sd_by_id[df$id]
df$r  <- r_by_id[df$id]

by_cols <- rti_by(df, id, time, y, sd, r)
by_cols[, c("id","n","estimate","se","z","p","ci_lower","ci_upper")]
```

You can extract and plot a specific person’s fit:

```{r}
# Pick id "a"
fit_a <- by_cols$fit[[ which(by_cols$id == "a") ]]
plot(fit_a, band = "slope")
```

---

## Choosing `sd` and `r`

- **`sd` (single-occasion SD)**: from a relevant external sample, on the same scale as the within-person outcome.  
- **`r` (reliability)**: test–retest or multiple-timepoint ICC reliability for the outcome, measured at an appropriate time frame.  
- If you can’t find perfect matches, document your choice and consider sensitivity analyses (e.g., try using a lower reliability coefficient such as `r` = `0.80` vs `r` = `0.90`).

Small sensitivity check:

```{r}
sens <- vapply(c(0.80, 0.85, 0.90, 0.95), function(rr) {
  rti(y, sd = sd_ext, r = rr, t = t)$z
}, numeric(1))
data.frame(r = c(0.80, 0.85, 0.90, 0.95), Z = sens)
```

The higher the `r` value, the higher the RTI z-score.  

---

## Diagnostics, edge cases, and tips

- **Missingness**: `na.rm = TRUE` drops non-finite pairs of `(y, t)` with a warning.  
- **Degenerate time**: RTI requires variability in `t`; equal times imply \(S_{xx}=0\) → error.  
- **Very short series**: With \(n=2\), RTI = RCI-like; with \(n=3\), expect wide uncertainty.  
- **Scaling**: If `t` is in weeks vs. sessions, the slope is per time unit; choose a unit meaningful for interpretation.    
- **Bands**:  
  - `band = "slope"` communicates the uncertainty about directional change, but ignores uncertainty about the intercept.  
  - `band = "mean"` adds intercept uncertainty via \(1/n\).  
  - `band = "prediction"` is for forecasting ranges of future scores. This is generally not necessary when using the RTI or RCI.  

---

## Mathematical identities used

For equal spacing \(t=1,\ldots,n\): \(S_{xx} = \sum (t-\bar t)^2 = n(n^2-1)/12\).  
RTI’s slope SE uses \(\sigma^2 = \texttt{sd}^2(1-r)\) from reliability.

You can verify quickly:

```{r}
n <- 9; t <- 1:n
Sxx_direct <- sum( (t - mean(t))^2 )
Sxx_closed <- n*(n^2 - 1)/12
all.equal(Sxx_direct, Sxx_closed)
```

---

## References

- Jacobson, N. S., & Truax, P. (1991). *Clinical significance: A statistical approach to defining meaningful change in psychotherapy research.* **Journal of Consulting and Clinical Psychology, 59**(1), 12–19.  
- McAleavey, A. A. (2024). *When (not) to rely on the reliable change index: A critical appraisal and alternatives to consider in clinical psychology.* **Clinical Psychology: Science and Practice, 31**(3), 351–366. https://doi.org/10.1037/cps0000203

---

## Session info

```{r}
sessionInfo()
```
