---
title: "Introduction_to_ReliableTrendIndex"
output: 
  rmarkdown::html_vignette: 
    fig_width: 7 
    fig_height: 7
vignette: >
  %\VignetteIndexEntry{Introduction_to_ReliableTrendIndex}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ReliableTrendIndex)
library(ggplot2)
```

I hope no one ever reads this. Except me, probably, when I want to do revisions to some paper later on. 

The package `{ReliableTrendIndex}` is a way to contain a large group of disorganized analysis functions related to the malformed concept of reliable change. There are a few key functions. 

### `reliableTrend()` and the `reliableTrend` class  

The function `reliableTrend()` creates objects of class `reliableTrend`. This class is just a list with fixed, named entries. You can read about it in `?reliableTrend()`.  

### Meta-analysis backbone  

The functions are mostly wrappers around functions from the `{metafor}` package, available on CRAN. The chief of these is `metafor::rma()`, which conducts simple univariate meta-analyses. Read about it at `?metafor::rma()`. It was worth developing wrapper functions for me because **A)** those functions are much more complex than the RCI/RTI I am working with here, and **B)** the variables in that package are named appropriately nonspecific things for meta-analysis, but overly complex things for this purpose. At the same time, any upstream changes to `{metafor}` will cause problems for this package.  

## Workflows  

Some basic usage examples are provided in `?reliableTrend`, `?simple_rma`, `?rti_to_df` and others. 
The two essential use cases are when you have one person, and when you have more than one person. 

### One person workflows  

Obviously, this is the simple case. See the README for examples.  

### Multi-person workflows  

In the case of analyzing a lot of data simultaneously (e.g., in a research project or simulation study), the simplest way to think about it is doing the previous case iteratively. However, you might have one, two, or five hundred observations for a given person - it would be ideal to have an analysis system that could handle all of those cases. 

We have a simulated data set available in the package. 

```{r}
simulated_data
```

The data has 500 individuals (`id`) with true scores at varying number of observations. Each person was measured between 4-20 times. (If you have fewer than 4 observations per person, the RTI will return the same value as the RCI.) There is an average effect of increasing scores over time, and the true scores all follow a linear pattern, but there is noise added to the `obs_score` variable. Specifically, it has a random normal variable added with SD = .2.  

```{r example of multiple ppl, warning=FALSE}
sim_data_2 <- simulated_data %>%
  split(.$id) %>%
  purrr::map(~ rti(values = .$obs_score, sem = .2)) %>%
  # purrr::map(reliableTrend) %>%
  purrr::map_dfr(rti_to_df) %>% 
  mutate(id = simulated_data %>% 
           group_by(id) %>% 
           slice_tail(n = 1) %>% 
           pull(id)) %>% 
  right_join(simulated_data) %>% 
  group_by(id) %>% 
  mutate(first_obs = first(obs_score), 
         last_obs = last(obs_score)) %>% 
  slice_tail(n = 1)
```

if we want to compare the RCI to RTI we could see how similar they are: 

```{r}
table(sim_data_2$category.RCI)
table(sim_data_2$category.RTI)
```

In this data, the RTI identifies `r sum(sim_data_2$category.RCI != "Less than reliable")` people as "reliably" changed Compared to the `r sum(sim_data_2$category.RTI != "Less than reliable")` of the RCI. 

```{r}
table(sim_data_2$category.RCI, 
      sim_data_2$category.RTI, 
      sim_data_2$true_change)
```

The top table is people whose true scores truly decreased, the bottom are the people whose true scores truly increased. The rows are the RCI categories and the columns are the RTI.  

We can see that:   

* `r sum(sim_data_2$true_change == "True Decrease" & sim_data_2$category.RTI == "Reliable Decrease" & sim_data_2$category.RCI == "Less than reliable")` people who truly decreased were identified correctly by the RTI but 'Less than reliable' by the RCI. In contrast, the RCI only identified `r sum(sim_data_2$true_change == "True Decrease" & sim_data_2$category.RCI == "Reliable Decrease" & sim_data_2$category.RTI == "Less than reliable")` people who truly decreased while the RTI said they were 'Less than reliable.'   

Overall, other comparisons are in favor of the RTI in most cases.  

RCI versus truth: 
```{r example of multiple ppl2}
table(sim_data_2$category.RCI, sim_data_2$true_change)
```

RTI versus truth: 
```{r example of multiple ppl3}
table(sim_data_2$category.RTI, sim_data_2$true_change)
```

This comparison is fairly favorable to the RCI, as it  allows the RCI to classify about 70% of individuals. In applied data, this would be unusual (though not unheard of), because the RCI generally  fails to classify 40-70% of individuals (largely as a function of the ratio of reliability and effect size). 

### Plotting the sample  

It is possible to construct a plot with pre-post scores indicating individuals' RCI status. 


```{r}
ggplot(data = sim_data_2,
       aes(x = last_obs, 
           y = first_obs)) +
  geom_abline(slope = 1, 
              intercept = c(0, 
                            1.96*.2*sqrt(2), 
                            -1.96*.2*sqrt(2)), 
              linetype = c("solid", "dashed", "dashed")) + 
  geom_ribbon(aes(ymax = last_obs + 1.96*.2*sqrt(2), 
                  ymin = last_obs - 1.96*.2*sqrt(2)), 
              fill = "blue", 
              alpha = .1) +
  geom_point(aes(shape = category.RCI, 
                 color = category.RCI)) + 
  labs(title = "RCI plot", 
       y = "Pre-treatment score", 
       x = "Post-treatment score")
```

That plot is similar to the Jacobson & Truax method, and shows the traditional effects. 

```{r}
ggplot(data = sim_data_2,
       aes(x = last_obs, 
           y = first_obs)) +
  geom_abline(slope = 1, 
              intercept = c(0, 
                            1.96*.2*sqrt(2), 
                            -1.96*.2*sqrt(2)), 
              linetype = c("solid", "dashed", "dashed")) + 
  geom_ribbon(aes(ymax = last_obs + 1.96*.2*sqrt(2), 
                  ymin = last_obs - 1.96*.2*sqrt(2)), 
              fill = "blue", 
              alpha = .1) +
  geom_point(aes(shape = category.RTI, 
                 color = category.RTI)) + 
  labs(title = "RTI plot", 
       y = "Pre-treatment score", 
       x = "Post-treatment score")
```

In that plot, we can see many of the points within the uncertainty band are actually reliably different from their baseline score, and a small number of points outside it are actually not very convincingly reliably different from baseline. From the RCI's perspective, those latter few people are misclassified by the RTI. But the same can be said in reverse for the many others within the shaded area in the second plot.  

A more RTI-centric plot would involve estimating the linear trend along with its uncertainty, much like a caterpillar plot, or a plot of the estimated confidence in Increase/Decrease directly. 

```{r}
ggplot(sim_data_2, 
       aes(x = reorder(slope.est, slope.est),  
           y = slope.est, 
           ymin = slope.lb, 
           ymax = slope.ub)) +
  geom_hline(yintercept = 0, 
             linetype = "dashed") +
  geom_pointrange(aes(color = category.RTI)) +
  labs(title = "RTI Caterpillar plot", 
       x = "Patient", 
       y = "Estimated slope per observation") +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())

```


Compare that plot to the same observations colored by the corresponding RCI categories: 


```{r}
ggplot(sim_data_2, 
       aes(x = reorder(slope.est, slope.est),  
           y = slope.est, 
           ymin = slope.lb, 
           ymax = slope.ub)) +
  geom_hline(yintercept = 0, 
             linetype = "dashed") +
  geom_pointrange(aes(color = category.RCI)) +
  labs(title = "RCI Caterpillar plot", 
       x = "Patient", 
       y = "Estimated slope per observation") +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank())
```

Here we are showing the same RTI data only coloring it by the RCI determination. The differences are relatively minor in this case, and occur only in two cases: The first and more common case is when the RTI's CI excludes 0 but the RCI is not able to notice this (it always as as large or larger error).  

The second cause is when the pre-post difference score is larger than the RTI's estimated slope over that time interval, and the increase in precision due to using the RTI does not compensate for the smaller estimate of change. This occurs seldom, and will be due to an unusually large pre-post difference score compared to the other observations for an individual - in this data, due entirely to measurement error. That is, the RCI detected a large change mostly due to measurement error, while the RTI detected a smaller or less consistent change based on more observations.  

A confidence in change plot. 

WIP::

```{r}
sim_data_3 <- sim_data_2 %>% 
  ungroup() %>% 
  mutate(diff_obs = last_obs - first_obs) %>% 
  arrange(diff_obs)

max(sim_data_3$diff_obs)
class(sim_data_3$diff_obs)

ggplot(sim_data_3, 
       aes(x = diff_obs, 
           y = pd.RTI)) +
  geom_point(aes(color = true_change)) +
  lims(y = c(0, 1)) +
  theme_bw() +
  labs(title = "RTI confidence in either change")

ggplot(sim_data_3, 
       aes(x = diff_obs, 
           y = pd.RCI)) +
  geom_point(aes(color = true_change)) +
  lims(y = c(0, 1)) +
  theme_bw() +
  labs(title = "RCI confidence in either change")


ggplot(sim_data_3 %>% 
         arrange(diff_true), 
       aes(x = diff_true, 
           y = pd.RTI)) +
  geom_point() +
  lims(y = c(0, 1)) +
  theme_bw() +
  labs(title = "RTI confidence in either change")

ggplot(sim_data_3 %>% 
         arrange(diff_true), 
       aes(x = diff_true, 
           y = pd.RCI)) +
  geom_point() +
  lims(y = c(0, 1)) +
  theme_bw() +
  labs(title = "RCI confidence in either change")


ggplot(sim_data_3 %>% 
         arrange(diff_true), 
       aes(x = pd.RTI, 
           y = pd.RCI)) +
  geom_point() +
  # lims(y = c(0, 1), 
  #      x = c(0, 1)) +
  theme_bw() +
  labs(title = "Confidence rather than correctness")


```

